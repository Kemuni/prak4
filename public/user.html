<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>

  <title>User page</title>
</head>
<body>
<div class="flex flex-col m-auto" style="width: 80%;">
  <h1 class="text-3xl mb-2">Пользовательская панель</h1>

  <div id="result"></div>
  <div class="flex flex-col gap-2 mt-4">
    <input id = "messageArea" type="text" size="30" class="border block">
    <input type="submit" value="Отправить" onclick=sendMessage() class="border block"><br>
    <div id="textArea"></div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    query = `{
      categories {
        id, name, products {
          id, name, price, description
        }
      }
    }`;
    $.ajax({
        url: '/graphql',
        method: 'post',
        headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
        },
        data: JSON.stringify({
            query: query,
            variables: null,
        }),
        success: (data) => {
            data = data.data.categories;
            let productsRowsHTML = '';
            for (const category of data) {
                productsRowsHTML += `<h2 class="text-2xl">${category.name}</h2>`;
                productsRowsHTML += '<div class="flex gap-2">';
                for (const product of category.products) {
                    productsRowsHTML += '<div class="flex flex-col border p-2" style="width: 30%">'
                    productsRowsHTML += `<p>Название: ${product.name}</p>`;
                    productsRowsHTML += `<p>Цена: ${product.price} руб.</p>`;
                    productsRowsHTML += `<p>Описание: ${product.description}</p>`;
                    productsRowsHTML += '</div>'
                }
                productsRowsHTML += '</div>'
            }

            $('#result').wrapInner(productsRowsHTML);
        }
    });

</script>
<script>
    const connection = new WebSocket("ws://localhost:9000");

    // если соединение успешно установлено
    connection.onopen = (event) => {
        console.log("Connection opened");
    };

    // если возникла ошибка
    connection.onerror = (error) => {
        console.log(`WebSocket Error: ${error}`);
    };

    // если соединение закрыто
    connection.onclose = (event) => {
        console.log("Connection closed");
    };

    // получаем ответ сервера
    connection.onmessage = (event) => {
        console.log(event.data)
        const eventJson = JSON.parse(event.data);
        message = document.createElement('p');
        message.textContent = `${eventJson.sender === 'user' ? 'Вы' : 'Модератор'}: ${eventJson.content}`;
        document.getElementById('textArea').append(message);
        console.log("Server response:", event.data);
    };

    function sendMessage() {
        text = document.getElementById('messageArea').value;
        if (text === "") {
            alert("Пожалуйста, введите непустую строку")
        } else {
            connection.send(JSON.stringify({sender: "user", content: text}));
            document.getElementById('messageArea').value = '';
        }
    }
</script>
</body>
</html>